{% extends 'layout.html' %}
{% block body %}
<div class="container-wide" ng-controller="homeCtrl">
	<div class="row">
		<div class="col-md-10" style="width:inherit">
			<div id="twitchContainer" style="">
			</div>
		</div>
		<div style="background-color:#DDDDDD;height:380px;overflow-y: auto;">
			
			<div class="well" style="width:100%;" ng-repeat="item in currentEvents">
				[[item.name]] - [[item.game]]
			</div>
		</div>
	</div>
	<div class="row">
  <div id="streamDescription">
    
  </div>
	<div>
	  <h1>Coming Up Events:</h1>
	  <div class="well" style="width:100%;" ng-repeat="item in upcomingEvents">
		  [[item.startTime.toString()]]:  [[item.name]]
	  </div>

    <div id="calendar" style="padding:50px">

  </div>

	</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
function homeCtrl($scope, $http) {
	function Event(name, link, game, date){
		this.name = name;
		this.link = link;
		this.game = game;
		this.startTime = date;
		this.endTime = date;
	}

	$scope.currentEvents = [new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)), new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)), new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)),new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)),new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)),new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0)),new Event("EVO", "twitch.com", "Melee", new Date(2014, 07, 11, 8, 30, 0, 0))];

	//$scope.upcomingEvents = [];

  // using a dictionary with id for events
  $scope.events = new Object();

	/*var currentDate = new Date();
	$http.get('/api/event/search?orderBy=id&sortOrder=DESC&maxDate='+currentDate.getTime()).
		    success(function(resp, status, headers, config) {
		    	$scope.upcomingEvents = resp.data.results
		    }).
		    	error(function(data, status, headers, config) {
		    });*/

	getTopGameStream(false, function(twitchPlayer) {
      $("#twitchContainer").append(twitchPlayer);
    });

    function addEventToCalendar(start, end, timezone, addEventCallback) {
          var currentDate = new Date();
          $.ajax( '/api/event/search?orderBy=id&sortOrder=DESC' )
          .done(function(data) {
            	var results = data.data.results;
              var events = [];
              for(var i=0; i < results.length; i++) {
                  // store the event in the dictionary
                  $scope.events[results[i].id] = results[i];
                  // create the event object for the calendar
                  events.push({
                      id: results[i].id,
                      title: results[i].gameName,
                      url: "#" + results[i].id,
                      start: new Date(results[i].startTime).toISOString(),
                      end: new Date(results[i].endTime).toISOString() 
                  });
              }
              // adds the events to the calendar
              addEventCallback(events);
          })
          .fail(function() {
              console.log( "error getting the latest events" );
          });
      }

    var originalBackgroundColor = "rgb(58, 135, 173)";
    var lastEventClicked = null;
    $('#calendar').fullCalendar({
        eventClick: function(calEvent, jsEvent, view) {
 
            var channelName = getChannelName($scope.events[calEvent.id].streamUrl);
            var twitchPlayer = buildEmbedPlayer(true, false, channelName);
            $("#twitchContainer").html(twitchPlayer);
            $("#streamDescription").html([calEvent.id].description);

            // scroll to the top
            $("html, body").animate({ scrollTop: 0 }, "slow");

            // change the background color and reset the color for the last event
            $(this).css('background-color', 'rgb(58, 200, 173)');
            if(lastEventClicked != null) {
              lastEventClicked.css('background-color', originalBackgroundColor);
            }
            lastEventClicked = $(this);
        },
        events: addEventToCalendar
    });
}
</script>
{% endblock %}
